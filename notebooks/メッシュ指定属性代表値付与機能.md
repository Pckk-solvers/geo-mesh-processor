# 要件定義書：メッシュへ指定属性代表値付与

## 1. 機能概要

* **機能名**：メッシュへ指定属性代表値付与
* **目的**：基準メッシュ（base\_mesh）に対して、任意の属性メッシュ（land\_mesh）の指定フィールドの値を面積割合で代表選択し、属性を付与する。
* **起動方法**：`app.py` のランチャーから呼び出し可能なサブコマンド／GUIボタンとして実装。

## 2. 対象データ・フォーマット

| 種別     | ファイル形式 | 必須フィールド                  | 備考                                                |
| ------ | ---------- | ------------------------ | ------------------------------------------------- |
| 基準メッシュ | Shapefile  | geometry                 | `mesh_id` が存在しない場合は自動生成。CRS は両入力レイヤで同一であること。      |
| 属性メッシュ | Shapefile  | geometry, `source_field` | `source_field` は文字列。対象フィールド名を指定。CRS は基準メッシュと完全一致。 |

## 3. 入出力仕様

* **入力引数**（CLI／GUI オプション）

  * `--base`：基準メッシュファイルのパス
  * `--land`：属性メッシュファイルのパス
  * `--source-field`：属性メッシュから読み取るフィールド名（省略時：`landuse`）
  * `--output-field`：出力時に付与する代表属性フィールド名（省略時：`dominant_value`）
  * `--output`：出力ファイル名（省略時：`base_land_mesh.shp`）
  * `--nodata`：Nodata 値（省略時：-9999）
  * `--threshold`：面積比しきい値（省略時：0.5）

* **出力仕様**

  * ジオメトリ：`base_mesh` と同一（CRS も完全一致）
  * 付与する属性：

    * `{output_field}`（文字列 または Nodata 値）

      * セル内で最も面積割合の大きい `{source_field}` の値
      * 最大割合が閾値未満の場合は Nodata 値
    * `{output_field}_ratio`（浮動小数）
      * **説明** 出力された代表属性({output_field})が当該メッシュセル内で占める面積割合を、0.0 ~ 1.0の値で示す。

## 4. 前提条件・環境

* Python 3.13 以上
* `geopandas`, `pandas`, `shapely`, `fiona` がインストール済み
* 入力データは同一 CRS に整合済みであること
* 出力ファイルは入力 CRS と完全一致で書き出す

## 5. 機能詳細（処理フロー）

0. **mesh\_id 自動生成**

   * `base_mesh` に `mesh_id` 列がない場合、`base_mesh['mesh_id'] = range(len(base_mesh))` で生成
1. **ファイル読み込み**

   * `--base`, `--land` で指定されたファイルを GeoDataFrame として読み込む
2. **CRS 確認**

   * 入力両レイヤの CRS が一致しない場合はエラー終了
3. **交差処理**

   * `gpd.overlay(base_mesh, land_mesh, how="intersection")` で断片化
4. **断片面積計算**

   * 断片 GeoDataFrame に `int_area = geometry.area` を計算（同一 CRS の単位²）
5. **属性別面積集計**

   * `(mesh_id, source_field)` ごとに `int_area` を合計し `int_area_sum` を生成
6. **セル面積計算**

   * `base_mesh` に `mesh_area = geometry.area` を追加
7. **割合算出**

   * `ratio = int_area_sum / mesh_area`
8. **代表値選択**

   * 同一 `mesh_id` 内で `ratio` が最大の `source_field` 値を候補とする
   * **同率（タイ）** 場合は交差処理時の先出し順序を優先
   * 最大 `ratio` が `--threshold` 未満の場合は Nodata 値を設定
9. **結果結合**

   ```python
   result = base_mesh.merge(
       dominant[['mesh_id', source_field, 'ratio']],
       on='mesh_id', how='left'
   )
   result = result.rename(
       columns={
           source_field: output_field,
           'ratio': f'{output_field}_ratio'
       }
   )
   ```
10. **ファイル出力**

* 指定された `--output` パスに Shapefile 等で書き出し

## 6. 例外・エラー処理

* `mesh_id` の重複／欠損：エラー終了
* 入力ファイル読込失敗：エラーメッセージ表示、終了
* CRS 不一致：エラー終了
* 交差結果ゼロ行：警告出力後、全セルに Nodata 属性を付与して出力

## 7. 非機能要件

* 数万セル規模でも数分以内に完了する性能
* ログレベル（INFO/DEBUG）設定あり
* 主要ロジックのユニットテストを用意し、カバレッジ 80％以上を目指す

## 8. テスト・受入基準

* **正常系**：サンプルデータで `{output_field}`, `{output_field}_ratio` が正しく付与される
* **境界系**：同率ケース、閾値境界（ちょうど 0.5）の動作を検証
* **異常系**：CRS 不一致、`mesh_id` 重複時のエラー動作を確認

## 9. 依存関係・ドキュメント

* 依存ライブラリ：`geopandas`, `pandas`, `shapely`, `fiona`
* README に使用例、オプション説明、サンプルコマンドを明文化

# 10. 詳細設計

## 10.1. 画面イメージ（GUI例）

* 起動画面サンプル（ラフ・参考）

```
┌────────────────────────────────────────────┐
│ メッシュへ指定属性代表値付与ツール            │
├────────────────────────────────────────────┤
│ [基準メッシュ(.shp)]  [ファイルパス]  [参照] │
│ [属性メッシュ(.shp)]  [ファイルパス]  [参照] │
│ 属性フィールド名:      [landuse ▼]          │
│ 出力フィールド名:      [dominant_value]     │
│ 面積比しきい値:        [0.5]                │
│ Nodata値:             [-9999]              │
│ 出力ファイル:         [ファイルパス]  [参照] │
│                                     [実行] │
│                                            │
└────────────────────────────────────────────┘
```

* フィールド選択はプルダウン、エラー時は別ウィンドウに日本語メッセージを表示

---

## 10.2. 入出力データ例

### 入力データ例

#### 基準メッシュ（base\_mesh.shp, \*.dbf抜粋）

| mesh\_id | geometry     |
| -------- | ------------ |
| 1        | POLYGON(...) |
| 2        | POLYGON(...) |
| ...      | ...          |

#### 属性メッシュ（land\_mesh.shp）

| geometry     | landuse |
| ------------ | ------- |
| POLYGON(...) | 森林      |
| POLYGON(...) | 農地      |
| POLYGON(...) | 市街地     |
| ...          | ...     |

### 出力データ例

| mesh\_id | geometry     | dominant\_value | dominant\_value\_ratio |
| -------- | ------------ | --------------- | ---------------------- |
| 1        | POLYGON(...) | 森林              | 0.65                   |
| 2        | POLYGON(...) | 農地              | 0.51                   |
| 3        | POLYGON(...) | -9999           | 0.00                   |

※ dominant\_valueは最も面積比率の高い属性（例：landuse）名、比率は0.0～1.0

---

## 10.3. アルゴリズムの流れ図・処理例

### フローチャート（文章ベース）

1. **入力ファイル読み込み**
   　`base_mesh.shp` と `land_mesh.shp` をGeoDataFrameとして読み込み

2. **CRS整合チェック**
   　異なる場合はエラー終了

3. **mesh\_id列付与（未存在なら連番自動付与）**

4. **overlay(intersection)で交差断片化**
   　各メッシュセルと属性ポリゴンの重複部分ごとに新しいポリゴンを作る

5. **断片面積計算**
   　各断片ごとに`int_area = geometry.area`を計算

6. **mesh\_id×source\_fieldごとに面積合計 → 面積比算出**
   　例：
   　- mesh\_id=1, landuse=森林, 合計70
   　- mesh\_id=1, landuse=農地, 合計30
   　→ セル面積100なら比率は0.7/0.3

7. **最大比率をもつ属性を選択。しきい値未満はNodata**

8. **結果をbase\_meshとmergeし、dominant\_value, dominant\_value\_ratioを列追加**

---

### サンプルPython（コア処理抜粋）

```python
# 3. overlayによる断片化
overlay_gdf = gpd.overlay(base_mesh, land_mesh, how="intersection")

# 4. 面積計算
overlay_gdf["int_area"] = overlay_gdf.geometry.area

# 5. mesh_id×属性ごとに集計
area_stat = overlay_gdf.groupby(["mesh_id", source_field])["int_area"].sum().reset_index()

# 6. セル面積取得（base_meshから）
mesh_area = base_mesh.set_index("mesh_id").geometry.area

# 7. 比率算出
area_stat["ratio"] = area_stat.apply(
    lambda r: r["int_area"] / mesh_area[r["mesh_id"]], axis=1
)

# 8. 最大比率の属性を選択
dominant = (
    area_stat.sort_values("ratio", ascending=False)
    .groupby("mesh_id")
    .first()
    .reset_index()
)
# しきい値未満はNodata
dominant.loc[dominant["ratio"] < threshold, source_field] = nodata

# 9. base_meshに結合
result = base_mesh.merge(
    dominant[["mesh_id", source_field, "ratio"]],
    on="mesh_id", how="left"
)
result = result.rename(
    columns={source_field: output_field, "ratio": f"{output_field}_ratio"}
)
```

---

## 10.4. 代表値判定ロジックの詳細

### 代表値の決定方法
1. 各メッシュセル内で、属性ポリゴンとの重なり面積を計算
2. 面積比率（重なり面積 ÷ メッシュセル面積）を算出
3. 面積比率が最大の属性を代表値として選択
   - 同率1位が複数ある場合：`overlay`で先に処理された方（インデックスが小さい方）を優先

### 閾値（`--threshold`）の動作
- **目的**：信頼性の低い代表値を除外する
- **デフォルト値**：0.5（50%）
- **動作**：
  - 最大面積比率が閾値未満の場合、そのメッシュの代表値はNodata値（`--nodata`で指定）に設定
  - 例：`--threshold 0.5`の場合、最大面積比率が50%未満ならNodata

### Nodata値（`--nodata`）の取り扱い
- **デフォルト値**：-9999
- Nodataが設定される条件：
  1. 最大面積比率が閾値未満
  2. 属性値が欠損値（`None`）または空文字（`""`）
  3. メッシュセルと属性ポリゴンが交差しない

### エッジケースの処理
- **交差なし**：Nodata値（`--nodata`で指定）を設定
- **空の属性値**：Nodata値として扱う
- **無効なジオメトリ**：エラーを出力してスキップ

---

## 10.5. よくある質問・FAQ

* **Q. 入力属性名は自由に指定できますか？**
  → はい。GUI/CLIどちらでも任意のフィールドを指定可能です。
* **Q. CRSが違う場合はどうなりますか？**
  → エラーで処理を中断し、理由を表示します。QGIS等でCRS統一してから再実行してください。
* **Q. 代表値がNodataになる場合は？**
  → 面積比がしきい値未満、または属性が空欄の場合はNodata値（-9999など）を出力します。

---

## 10.6. サンプルコマンド・シナリオ

**CLIサンプル**

```
python mesh_dominant.py --base base_mesh.shp --land land_mesh.shp --source-field landuse --output-field dom --output out.shp --threshold 0.5
```

**GUI利用例**

* 必須ファイル・パラメータをGUIで選択し、\[実行]を押すだけで出力まで完結
* エラーは別ウィンドウで日本語表示

